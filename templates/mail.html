
<template>
    <style>

        #cmbMail > option:hover{
            background-color: crimson;
            color: aliceblue;
            cursor: pointer;
        }

    </style>
  
    <h1>Mensagens</h1>
    <fieldset>
        <legend>Recebidas</legend>
        <select id="cmbMail" size="10"></select>
    </fieldset>          
        
    <fieldset>
        <legend>Nova</legend>
        <div class="inline">
            <label for="cmbUser">Destinatário</label>
            <select id="cmbUser"></select>
        </div>
        <textarea id="edtMail" cols="30" rows="10" maxlength="255"></textarea>
        <button id="btnEnviar">Enviar</button>
    </fieldset>

</template>

<script>

    main_data.mail.fillUsers = ()=>{
        const params = new Object;
            params.hash = localStorage.getItem('hash')
        fillCombo('cmbUser',params,26,['id','nome'], '#')
    }

    main_data.mail.fillMail = ()=>{
        const params = new Object;
            params.id_user = localStorage.getItem('id_user')
        const myPromisse = queryDB(params,53)
        myPromisse.then((txt)=>{
            const json = JSON.parse(txt)
            const sel = document.querySelector('#cmbMail')
            let unread = 0
            for(let i=0; i<json.length; i++){
                unread += parseInt(json[i].nao_lida)
                const op = document.createElement('option')
                op.value = json[i].id
                op.innerHTML = json[i].txt.substr(0,60)
                op.style = json[i].nao_lida == '1' ? 'font-weight: 900;' : 'font-weight: 200;'
                op.data = json[i]
                sel.appendChild(op)
            }     
            document.querySelector('#badge').innerHTML = unread > 0 ? unread : ''            
            console.log(json)
        })
    }

    main_data.mail.fillUsers()
    main_data.mail.fillMail()

    document.querySelector('#btnEnviar').addEventListener('click',()=>{
        const sel = document.querySelector('#cmbUser')
        
        if(sel.value != ''){
            const params = new Object;
                params.de = localStorage.getItem('id_user')
                params.para = sel.value
                params.txt = document.querySelector('#edtMail').value
            const myPromisse = queryDB(params,54)
            myPromisse.then(()=>{
                alert('Mensagem enviada com sucesso')
                closeModal('mail')
            })

        }else{
            alert('Selecione um destinatário!')
            sel.focus()
        }

    })

    document.querySelector('#cmbMail').addEventListener('dblclick',()=>{
        const sel = document.querySelector('#cmbMail')
        const data = sel.options[sel.selectedIndex].data     
        alert(data.txt)
        const params = new Object;
            params.id = data.id
        const myPromisse = queryDB(params,55)
        myPromisse.then(()=>{
            checkMail()
        })


    })


</script>